{% extends 'base.html' %}

{% block content %}
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-pyc-purple mb-6">Add a New Song</h1>
        
        <!-- Display Form Errors -->
        {% if song_form.errors %}
            <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg shadow-sm">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-circle text-xl mr-3 mt-1"></i>
                    <div>
                        <strong class="font-semibold">Oops! Please fix the following errors:</strong>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            {% for field in song_form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Display Form -->
        <form method="POST" enctype="multipart/form-data" action="{% url 'add_song' %}" class="bg-white rounded-lg shadow-md p-6">
            {% csrf_token %}
            
            <div class="mb-6">
                <label for="id_title" class="block text-sm font-semibold text-pyc-text mb-2">
                    Song Title <span class="text-red-500">*</span>
                </label>
                {{ song_form.title }}
            </div>
            
            <div class="mb-6">
                <label for="id_composer" class="block text-sm font-semibold text-pyc-text mb-2">
                    Composer <span class="text-red-500">*</span>
                </label>
                {{ song_form.composer }}
            </div>
            
            <div class="mb-6 bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300">
                <p class="font-bold text-pyc-purple mb-4 flex items-center">
                    <i class="fas fa-music mr-2"></i> Lyrics
                </p>
                
                <div id="lyrics-sections">
                    <div class="lyrics-section mb-4 bg-white p-4 rounded-lg shadow-sm border-l-4 border-pyc-purple" draggable="true">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-grip-vertical text-gray-400 cursor-move drag-handle"></i>
                                <label for="id_lyrics_title_1" class="text-sm font-medium text-pyc-text">
                                    Section 1 <span class="text-xs text-gray-500">(Add instructions inside brackets e.g. (softly, distant thoughtful wonder))</span>
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" class="duplicate-btn px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm" title="Duplicate section">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button type="button" class="delete-btn px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm" title="Delete section">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <input type="text" id="id_lyrics_title_1" name="lyrics_title_1" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pyc-purple focus:border-transparent mb-2" 
                               placeholder="Section title">
                        <textarea id="id_lyrics_1" name="lyrics_1" 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pyc-purple focus:border-transparent" 
                                  rows="4" placeholder="Lyrics for the section"></textarea>
                    </div>
                </div>

                <button type="button" 
                        class="px-4 py-2 bg-pyc-green text-white rounded-lg hover:bg-opacity-90 transition-colors flex items-center" 
                        onclick="addLyricsSection()">
                    <i class="fas fa-plus mr-2"></i> Add Section
                </button>
            </div>

            <div class="mb-6">
                <label for="id_youtube_link" class="block text-sm font-semibold text-pyc-text mb-2">
                    <i class="fab fa-youtube text-red-600 mr-1"></i> YouTube Link
                </label>
                {{ song_form.youtube_link }}
            </div>
            
            <div class="mb-6">
                <label for="id_slogan" class="block text-sm font-semibold text-pyc-text mb-2">
                    <i class="fas fa-quote-left mr-1 text-pyc-orange"></i> Slogan <span class="text-xs text-gray-500">(A verse or quote)</span>
                </label>
                {{ song_form.slogan }}
            </div>

            <div class="flex gap-3">
                <button type="submit" 
                        class="px-6 py-3 bg-pyc-purple text-white rounded-lg hover:bg-opacity-90 transition-colors font-semibold flex items-center">
                    <i class="fas fa-check mr-2"></i> Add Song
                </button>
                <a href="{% url 'song_list' %}" 
                   class="px-6 py-3 bg-gray-200 text-pyc-text rounded-lg hover:bg-gray-300 transition-colors font-semibold flex items-center">
                    <i class="fas fa-times mr-2"></i> Cancel
                </a>
            </div>
        </form>
    </div>

    <style>
        /* Style Django form fields */
        #id_title, #id_composer, #id_youtube_link {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        #id_title:focus, #id_composer:focus, #id_youtube_link:focus {
            outline: none;
            ring: 2px;
            ring-color: #4B3FA0;
            border-color: transparent;
        }

        .lyrics-section {
            transition: all 0.3s ease;
        }

        .lyrics-section:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .drag-handle {
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            CKEDITOR.replace("slogan");
            initializeDragAndDrop();
            attachSectionHandlers();
        });

        let sectionCount = 1;
        let draggedElement = null;

        function addLyricsSection(title = '', lyrics = '') {
            sectionCount++;
            const newSection = document.createElement('div');
            newSection.classList.add('lyrics-section', 'mb-4', 'bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border-l-4', 'border-pyc-purple');
            newSection.draggable = true;
            newSection.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-grip-vertical text-gray-400 cursor-move drag-handle"></i>
                        <label for="id_lyrics_title_${sectionCount}" class="text-sm font-medium text-pyc-text">Section ${sectionCount}</label>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" class="duplicate-btn px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm" title="Duplicate section">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button type="button" class="delete-btn px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm" title="Delete section">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <input type="text" id="id_lyrics_title_${sectionCount}" name="lyrics_title_${sectionCount}" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pyc-purple focus:border-transparent mb-2" 
                       placeholder="Section title" value="${title}">
                <textarea id="id_lyrics_${sectionCount}" name="lyrics_${sectionCount}" 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pyc-purple focus:border-transparent" 
                          rows="4" placeholder="Lyrics for the section">${lyrics}</textarea>
            `;
            document.getElementById('lyrics-sections').appendChild(newSection);
            attachSectionHandlers();
            renumberSections();
        }

        function attachSectionHandlers() {
            // Drag and drop
            document.querySelectorAll('.lyrics-section').forEach(section => {
                section.addEventListener('dragstart', handleDragStart);
                section.addEventListener('dragover', handleDragOver);
                section.addEventListener('drop', handleDrop);
                section.addEventListener('dragend', handleDragEnd);
            });

            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = function() {
                    if (document.querySelectorAll('.lyrics-section').length > 1) {
                        this.closest('.lyrics-section').remove();
                        renumberSections();
                    } else {
                        alert('You must have at least one section.');
                    }
                };
            });

            // Duplicate buttons
            document.querySelectorAll('.duplicate-btn').forEach(btn => {
                btn.onclick = function() {
                    const section = this.closest('.lyrics-section');
                    const title = section.querySelector('input[type="text"]').value;
                    const lyrics = section.querySelector('textarea').value;
                    addLyricsSection(title, lyrics);
                };
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const section = e.target.closest('.lyrics-section');
            if (section && section !== draggedElement) {
                const rect = section.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                if (e.clientY < midpoint) {
                    section.parentNode.insertBefore(draggedElement, section);
                } else {
                    section.parentNode.insertBefore(draggedElement, section.nextSibling);
                }
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            renumberSections();
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            document.querySelectorAll('.lyrics-section').forEach(section => {
                section.classList.remove('drag-over');
            });
        }

        function initializeDragAndDrop() {
            const container = document.getElementById('lyrics-sections');
            container.addEventListener('dragover', handleDragOver);
        }

        function renumberSections() {
            const sections = document.querySelectorAll('.lyrics-section');
            sections.forEach((section, index) => {
                const num = index + 1;
                const label = section.querySelector('label');
                const input = section.querySelector('input[type="text"]');
                const textarea = section.querySelector('textarea');
                
                label.textContent = `Section ${num}`;
                label.htmlFor = `id_lyrics_title_${num}`;
                input.id = `id_lyrics_title_${num}`;
                input.name = `lyrics_title_${num}`;
                textarea.id = `id_lyrics_${num}`;
                textarea.name = `lyrics_${num}`;
            });
            sectionCount = sections.length;
        }
    </script>
{% endblock %}