
<div
  id="audio-player-bar"
  class="fixed bottom-0 left-0 right-0 z-50 py-2 md:py-3 shadow-2xl border-t-2 border-pyc-orange/50 hidden"
  style="background-color: #4B3FA0E6; backdrop-filter: blur(10px);"
>
  <div class="container mx-auto px-2 sm:px-4 lg:px-8">
    <div class="flex flex-col md:flex-row items-center justify-between gap-2 md:gap-0">

      <!-- Song Title -->
      <div id="mp3-voice-part" class="flex items-center w-full md:w-auto justify-center md:justify-start text-white mb-1 md:mb-0">
        <i class="fa-solid fa-music text-base md:text-lg text-pyc-orange mr-2 md:mr-3"></i>
        <span id="mp3-voice-title" class="font-semibold text-sm md:text-lg truncate max-w-[200px] md:max-w-none">Play something</span>
      </div>

      <!-- Playback Controls -->
      <div class="flex items-center justify-center space-x-3 md:space-x-4">
        <button id="prev-btn" class="text-white/75 hover:text-white transition-colors p-1.5 md:p-2 rounded-full border border-white/20 hover:border-white">
          <i class="fa-solid fa-backward-step text-sm md:text-base"></i>
        </button>

        <button
          id="play-pause-btn"
          class="bg-pyc-orange text-white rounded-full shadow-lg flex items-center justify-center w-10 h-10 md:w-12 md:h-12 transition-transform hover:scale-105"
        >
          <i class="fa-solid fa-play text-base md:text-lg"></i>
        </button>

        <button id="next-btn" class="text-white/75 hover:text-white transition-colors p-1.5 md:p-2 rounded-full border border-white/20 hover:border-white">
          <i class="fa-solid fa-forward-step text-sm md:text-base"></i>
        </button>
      </div>

      <!-- Progress Bar and Time -->
      <div class="flex items-center w-full md:flex-grow-[2] md:ml-4 md:max-w-lg">
        <input
          type="range"
          id="seek-bar"
          class="w-full h-1 bg-pyc-orange/30 rounded-lg appearance-none cursor-pointer range-lg [&::-webkit-slider-thumb]:bg-pyc-orange [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 md:[&::-webkit-slider-thumb]:w-4 md:[&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:rounded-full [&::-moz-range-thumb]:bg-pyc-orange [&::-moz-range-thumb]:w-3 [&::-moz-range-thumb]:h-3 md:[&::-moz-range-thumb]:w-4 md:[&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full"
          value="0"
        />
        <small class="text-white ml-2 md:ml-4 text-xs md:text-sm whitespace-nowrap">
          <span id="current-time">0:00</span> /
          <span id="total-time">0:00</span>
        </small>
      </div>

      <audio id="audio-player" preload="metadata"></audio>
    </div>
  </div>
</div>

<script>
    const mp3VoiceTitle = document.getElementById("mp3-voice-title");
    const audioPlayer = document.getElementById("audio-player");
    const playPauseBtn = document.getElementById("play-pause-btn");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const seekBar = document.getElementById("seek-bar");
    const currentTimeDisplay = document.getElementById("current-time");
    const totalTimeDisplay = document.getElementById("total-time");
    const audioBar = document.getElementById("audio-player-bar");
    const mp3List = document.querySelectorAll(".mp3-voice");

    let playlist = [];
    let mp3Names = [];
    let currentTrackIndex = 0;
    let isSeeking = false; // Flag to prevent timeupdate interference

    // Function to load and play track
    function loadTrack(index) {
        if (index < 0 || index >= playlist.length) return;
        currentTrackIndex = index;
        mp3VoiceTitle.textContent = mp3Names[currentTrackIndex];
        audioPlayer.src = playlist[currentTrackIndex];
        audioPlayer.play();
        updatePlayPauseButton();
        audioBar.classList.remove("hidden"); // Show player when track starts
    }

    // Function to toggle play/pause
    function togglePlayPause() {
        if (audioPlayer.paused) {
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
        updatePlayPauseButton();
    }

    // Update play/pause button icon
    function updatePlayPauseButton() {
        const icon = playPauseBtn.querySelector("i");
        if (audioPlayer.paused) {
            icon.classList.remove("fa-pause");
            icon.classList.add("fa-play");
        } else {
            icon.classList.remove("fa-play");
            icon.classList.add("fa-pause");
        }
    }

    // Play next track
    function playNextTrack() {
        if (currentTrackIndex < playlist.length - 1) {
            loadTrack(currentTrackIndex + 1);
        }
    }

    // Play previous track
    function playPreviousTrack() {
        if (currentTrackIndex > 0) {
            loadTrack(currentTrackIndex - 1);
        }
    }
    // Update seek bar and time
    function updateSeekBar() {
        // Don't update if user is currently seeking
        if (isSeeking) return;
        
        if (audioPlayer.duration && !isNaN(audioPlayer.duration)) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            seekBar.value = progress;
            currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
        }
    }

    // Seek to position
    function seekAudio() {
        if (audioPlayer.duration && !isNaN(audioPlayer.duration)) {
            const percent = seekBar.value;
            audioPlayer.currentTime = (percent / 100) * audioPlayer.duration;
        }
        isSeeking = false; // Re-enable automatic updates
    }

    // Format time helper function
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? "0" : ""}${secs}`;
    }

    // Event listener for clicking an MP3 file
    mp3List.forEach((mp3Item, index) => {
        mp3Item.addEventListener("click", function () {
            const mp3Url = this.getAttribute("data-mp3-url");
            const mp3VoicePart = this.getAttribute("data-mp3-voice-part");
            const mp3Id = this.getAttribute("data-mp3-id");

            // If the song is already in the playlist, just play it
            if (playlist.includes(mp3Url)) {
                currentTrackIndex = playlist.indexOf(mp3Url);
            } else {
                playlist.push(mp3Url);
                mp3Names.push(mp3VoicePart)
                currentTrackIndex = playlist.length - 1;
            }

            // Set context for lyric syncing
            if (mp3Id) {
                audioPlayer.dataset.currentMp3Id = mp3Id;
                processTimestamps(mp3Id);
                
                // Reset lyric highlights
                lyricLines.forEach(line => {
                    line.classList.remove('active', 'played');
                });
                currentLine = null;
            }

            loadTrack(currentTrackIndex);
        });
    });

    // Event listeners for controls
    playPauseBtn.addEventListener("click", togglePlayPause);
    prevBtn.addEventListener("click", playPreviousTrack);
    nextBtn.addEventListener("click", playNextTrack);
    audioPlayer.addEventListener("timeupdate", updateSeekBar);
    audioPlayer.addEventListener("loadedmetadata", () => {
        totalTimeDisplay.textContent = formatTime(audioPlayer.duration);
        seekBar.max = 100;
        seekBar.value = 0;
    });
    seekBar.addEventListener("input", function() {
        // Set flag to prevent timeupdate from interfering
        isSeeking = true;
        
        // Update time display while dragging
        if (audioPlayer.duration && !isNaN(audioPlayer.duration)) {
            const percent = seekBar.value;
            const newTime = (percent / 100) * audioPlayer.duration;
            currentTimeDisplay.textContent = formatTime(newTime);
        }
    });
    seekBar.addEventListener("change", seekAudio);
    seekBar.addEventListener("mousedown", () => isSeeking = true);
    seekBar.addEventListener("touchstart", () => isSeeking = true);
    audioPlayer.addEventListener("ended", playNextTrack);
</script>

<!-- Highlight lyrics as song plays -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audioPlayer = document.getElementById('audio-player');
        const lyricLines = document.querySelectorAll('.lyric-line');
        const mp3List = document.querySelectorAll('.mp3-voice');
        let timestamps = {};
        let currentLine = null;
    
        // console.log("ðŸŽµ Script Loaded: Audio Player & Lyrics Initialized");
    
        // Process timestamps for current MP3
        function processTimestamps(mp3Id) {
            timestamps = {};
            // console.log(`ðŸŽ¶ Processing timestamps for MP3 ID: ${mp3Id}`);
    
            lyricLines.forEach(line => {
                const lineId = line.dataset.lineId;
                // console.log(`ðŸ”¹ Processing Lyric Line ID: ${lineId}`);
    
                const lineTimestamps = JSON.parse(line.dataset.timestamps);
                // console.log(`ðŸ“Œ Timestamps Data for Line ${lineId}: `, lineTimestamps);
    
                if (lineTimestamps[mp3Id]) {
                    timestamps[lineTimestamps[mp3Id]] = lineId;
                    // console.log(`âœ… Mapped Timestamp: ${lineTimestamps[mp3Id]}s -> Line ${lineId}`);
                }
            });
    
            // console.log("ðŸ•’ Final Timestamps Map: ", timestamps);
        }
    
        function updateLyrics(currentTime) {
            const times = Object.keys(timestamps).map(Number).sort((a, b) => a - b);

            if (times.length === 0) return;

            // Find the latest timestamp that has already passed
            const lastPassedTimestamp = times
                .filter(t => currentTime >= t)
                .pop(); // gets the most recent one (closest in the past)

            // No timestamps reached yet
            if (lastPassedTimestamp === undefined) return;

            const nextLineId = timestamps[lastPassedTimestamp];

            if (!currentLine || currentLine.dataset.lineId !== nextLineId) {
                // Mark old line as played
                if (currentLine) {
                    currentLine.classList.remove('active');
                    currentLine.classList.add('played');
                }

                // Activate new line
                currentLine = document.querySelector(`.lyric-line[data-line-id="${nextLineId}"]`);
                if (currentLine) {
                    currentLine.classList.add('active');
                    currentLine.classList.remove('played');
                    currentLine.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        }


        // Click on lyric line to seek to that timestamp
        lyricLines.forEach(line => {
            line.addEventListener('click', function() {
                const lineId = this.dataset.lineId;
                const lineTimestamps = JSON.parse(this.dataset.timestamps);
                const currentMp3Id = audioPlayer.dataset.currentMp3Id;
        
                if (currentMp3Id && lineTimestamps[currentMp3Id]) {
                    audioPlayer.currentTime = lineTimestamps[currentMp3Id];
                }
            });
        });
    
        // Update lyrics on timeupdate
        audioPlayer.addEventListener('timeupdate', () => {
            // console.log(`ðŸŽ¼ Audio Time Update: ${audioPlayer.currentTime}s`);
            updateLyrics(audioPlayer.currentTime);
        });
    
        // Reset lyrics when audio ends
        audioPlayer.addEventListener('ended', () => {
            // console.log("ðŸ Audio Ended: Resetting Lyrics.");
            if (currentLine) {
                currentLine.classList.remove('active');
            }
            lyricLines.forEach(line => line.classList.remove('played'));
            currentLine = null;
        });
    
        // console.log("ðŸŽ¬ Script Setup Complete!");
    });
    
</script>