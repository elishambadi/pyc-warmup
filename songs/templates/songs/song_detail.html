{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ song.title }}{% if song.composer %} - {{ song.composer }}{% endif %} | PYC WarmUp App{% endblock %}

{% block description %}
    Discover '{{ song.title }}' with lyrics {% if song.composer %} by {{ song.composer }}{% endif %}, a song on the PYC WarmUp App. Practice with synced lyrics, voice parts, and embedded video/audio training.
{% endblock %}

{% block og_title %}{{ song.title }}{% if song.composer %} - {{ song.composer }}{% endif %} | PYC WarmUp App{% endblock %}

{% block og_description %}
    Access '{{ song.title }}' with synced lyrics, training audio files, and video resources. Part of your choir preparation on the PYC WarmUp App.
{% endblock %}

{% block twitter_title %}{{ song.title }} | PYC WarmUp{% endblock %}

{% block twitter_description %}
    Enhance your choir practice with '{{ song.title }}'. Get synced audio/lyrics and training resources on the PYC WarmUp App.
{% endblock %}

<!-- add block keywords with song title and composer -->
{% block keywords %}Parklands Youth Choir, choir, warm-up, voice notes, {{ song.title }} lyrics, {% if song.composer %}, {{ song.composer }}{% endif %}{% endblock %}

{% block content %}

<style>
    .lyric-line {
        transition: all 0.3s ease;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
    }
    
    .lyric-line.active {
        background-color: #fef3c7;
        font-weight: 600;
        transform: scale(1.01);
        border-left: 4px solid #F36F21;
    }
    
    .lyric-line.played {
        color: #9ca3af;
    }
    
    .lyric-line:hover {
        background-color: #f9fafb;
    }
</style>

<div class="max-w-5xl mx-auto pb-32">
    
    <!-- Header with Title and Actions -->
    <div class="flex items-start justify-between mb-6">
        <div class="flex-1">
            <h1 id="song-title" class="text-3xl font-bold text-pyc-purple mb-2">
                {{ song.title }}
                {% if song.composer %}
                <span class="text-pyc-text/60 text-2xl">by {{ song.composer }}</span>
                {% endif %}
            </h1>
        </div>
        {% if user|is_admin %}
        <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm" id="delete-song-btn">
            <i class="fas fa-trash mr-2"></i>Delete Song
        </button>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-8 items-start mb-8">

        {% if song.youtube_link %}
        <div class="md:col-span-2">
            <div class="relative w-full" style="padding-bottom: 56.25%;">
                <iframe 
                    src="{{ song.youtube_link|youtube_embed }}" 
                    frameborder="0" 
                    class="absolute top-0 left-0 w-full h-full rounded-xl shadow-2xl"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen
                    >
                </iframe>
            </div>
        </div>
        {% endif %}

        {% if song.slogan %}
        <div class="md:col-span-2">
            <div class="p-6 h-full flex items-center bg-pyc-purple/10 border-l-4 border-pyc-purple rounded-xl shadow-lg">
                <blockquote class="text-pyc-text italic text-lg leading-relaxed">
                    {{ song.slogan|safe }}
                </blockquote>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- Voicenotes & Audios Section -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-pyc-text mb-4 flex items-center">
            <i class="fas fa-microphone text-pyc-orange mr-2"></i>
            Voicenotes & Audios
        </h2>
        
        <div class="bg-white rounded-lg shadow p-4">
            <ul id="mp3-files" class="space-y-2">
               
                {% if mp3s.count == 0 %}
                <li class="text-pyc-text/60 italic">No audio files available.</li>
                {% else %}
                    {% for mp3 in mp3s %}
                    <li class="flex items-center justify-between p-3 hover:bg-gray-50 rounded transition-colors">
                        <span class="mp3-voice text-pyc-purple font-medium cursor-pointer hover:text-pyc-orange transition-colors" 
                              data-mp3-url="{{ mp3.file.url }}" 
                              data-mp3-id="{{ mp3.id }}" 
                              data-mp3-voice-part="{{ mp3.voice_part }}">
                            <i class="fas fa-play-circle mr-2"></i>{{ mp3.voice_part }} Audio
                        </span>
                        {% if user|is_admin %}
                        <div class="flex gap-2">
                            <a href="{% url 'sync-mp3' mp3.id %}" 
                               class="px-3 py-1 bg-pyc-orange text-white rounded hover:bg-opacity-90 transition-colors text-sm">
                                {% if mp3.is_fully_synced %}
                                    <i class="fas fa-check mr-1"></i>Edit Sync
                                {% else %}
                                    <i class="fas fa-music mr-1"></i>Sync Lyrics
                                {% endif %}
                            </a>
                            <button class="px-3 py-1 bg-pyc-purple text-white rounded hover:bg-opacity-90 transition-colors text-sm edit-mp3-btn" 
                                    data-mp3-id="{{ mp3.id }}">Edit</button>
                            <button class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm delete-mp3-btn" 
                                    data-mp3-id="{{ mp3.id }}">Delete</button>
                        </div>
                        {% endif %}
                    </li>
                    {% endfor %}
                {% endif %}
            </ul>

            {% if user|is_admin %}
            <div class="mt-4 pt-4 border-t space-y-2">
                <input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pyc-purple focus:border-transparent" 
                       type="file" id="new-mp3-file">
                <input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pyc-purple focus:border-transparent" 
                       type="text" id="new-mp3-voice" placeholder="Voice Part">
                <button class="px-4 py-2 bg-pyc-green text-white rounded-lg hover:bg-opacity-90 transition-colors" 
                        id="add-mp3-btn">
                    <i class="fas fa-plus mr-2"></i>Add MP3
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Lyrics Section -->
    <div id="lyrics-content" class="mb-8">
        <h2 class="text-xl font-bold text-pyc-text mb-4 flex items-center">
            <i class="fas fa-align-left text-pyc-green mr-2"></i>
            Lyrics
        </h2>
        
        <div class="bg-white rounded-lg shadow p-6">
            {% if annotated_lines %}
                {% for item in annotated_lines %}
                    {% if item.is_new_section %}
                        <p class="mt-6 first:mt-0 text-sm font-semibold text-pyc-purple uppercase tracking-wide">
                            {{ item.line.section.name }}
                            <span class="text-pyc-text/60 normal-case font-normal italic ml-2">{{ item.line.section.instruction|default:'' }}</span>
                        </p>
                    {% endif %}
                    <p class="lyric-line my-1" 
                       data-line-id="{{ item.line.id }}" 
                       data-timestamps="{{ mp3_timestamps|get_item:item.line.id|default:'{}' }}">
                        {{ item.line.text }} 
                        <span class="text-pyc-text/50 italic text-sm">{{ item.line.instruction|default:'' }}</span> 
                    </p>
                {% endfor %}
            {% else %}
                <div class="prose max-w-none">{{ song.lyrics|safe }}</div>
            {% endif %}
        </div>
        
        <button class="mt-4 px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed" 
                disabled id="edit-lyrics-btn">
            Edit Lyrics
        </button>
    </div>

</div>

{% include 'songs/partials/player.html' %}

{% endblock %}


{% block extra_js %}
<script>
    document.getElementById('edit-lyrics-btn').addEventListener('click', function () {
        const lyricsContent = document.getElementById('lyrics-content');
        if (lyricsContent.contentEditable === "true") {
            lyricsContent.contentEditable = "false";
            this.textContent = "Edit Lyrics";
            saveLyrics(lyricsContent.innerHTML);
        } else {
            lyricsContent.contentEditable = "true";
            this.textContent = "Save Lyrics";
        }
    });

    function saveLyrics(newLyrics) {
        fetch("{% url 'save_lyrics' song.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ lyrics: newLyrics })
        }).then(response => response.json())
            .then(data => alert(data.success ? "Lyrics updated!" : "Error updating lyrics."));
    }

    // ðŸŽµ Edit & Add MP3
    document.querySelectorAll('.edit-mp3-btn').forEach(button => {
        button.addEventListener('click', function () {
            const mp3Id = this.dataset.mp3Id;
            const newVoicePart = prompt("Edit voice part:");
            if (newVoicePart) saveMP3(mp3Id, newVoicePart);
        });
    });

    document.getElementById('add-mp3-btn').addEventListener('click', function () {
        const file = document.getElementById('new-mp3-file').files[0];
        const voicePart = document.getElementById('new-mp3-voice').value;
        if (file && voicePart) addMP3(file, voicePart);
    });

    function saveMP3(mp3Id, newVoicePart) {
        fetch("{% url 'save_mp3' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ mp3_id: mp3Id, voice_part: newVoicePart })
        }).then(response => response.json())
            .then(data => alert(data.success ? "MP3 updated!" : "Error updating MP3."));
    }

    function addMP3(file, voicePart) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('voice_part', voicePart);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'add_mp3' song.id %}", {
            method: 'POST',
            body: formData
        }).then(response => response.json())
            .then(data => alert(data.success ? "MP3 added!" : "Error adding MP3."));
    }

    // ðŸ“ Edit & Add Notes
    document.getElementById('add-note-btn').addEventListener('click', function () {
        const section = document.getElementById('new-note-section').value;
        const content = document.getElementById('new-note-content').value;
        if (section && content) addNote(section, content);
    });

    function addNote(section, content) {
        fetch("{% url 'add_note' song.id %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ section, content })
        }).then(response => response.json())
            .then(data => alert(data.success ? "Note added!" : "Error adding note."));
    }

    // ðŸ”— Edit & Add References
    document.getElementById('add-reference-btn').addEventListener('click', function () {
        const link = document.getElementById('new-reference-link').value;
        if (link) addReference(link);
    });

    function addReference(link) {
        fetch("{% url 'add_reference' song.id %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ link })
        }).then(response => response.json())
            .then(data => alert(data.success ? "Reference added!" : "Error adding reference."));
    }

</script>

<script>
    // Delete song code
    document.getElementById('delete-song-btn').addEventListener('click', function () {
        if (confirm("Are you sure you want to delete this song?")) {
            fetch("{% url 'delete-song' song.id %}", {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Song deleted!");
                        window.location.href = "{% url 'song_list' %}";
                    } else {
                        alert("Error deleting song.");
                    }
                });
        }
    });

    // Delete MP3 code
    document.querySelectorAll('.delete-mp3-btn').forEach(button => {
        button.addEventListener('click', function () {
            const mp3Id = this.dataset.mp3Id;
            if (confirm("Are you sure you want to delete this MP3?")) {
                const url = `/delete-mp3/${mp3Id}/`;
                fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ mp3_id: mp3Id })
                }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("MP3 deleted!");
                            location.reload();
                        } else {
                            alert("Error deleting MP3.");
                        }
                    });
            }
        });
    });
</script>
{% endblock %}